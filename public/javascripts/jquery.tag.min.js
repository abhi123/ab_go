(function(a){a.extend(a.fn,{tag:function(c){c=a.extend({minWidth:100,minHeight:100,defaultWidth:100,defaultHeight:100,maxHeight:null,maxWidth:null,save:null,remove:null,canTag:!0,canDelete:!0,autoShowDrag:!1,autoComplete:null,defaultTags:null,clickToTag:!0,draggable:!0,resizable:!0,showTag:"hover",showLabels:!0,debug:!1},c);return this.each(function(){var b=a(this);b.data("options",c);a(window).load(function(){b.wrap('<div class="jTagContainer" />');b.wrap('<div class="jTagArea" />');a("<div class='jTagLabels'><div style='clear:both'></div></div>").insertAfter(b.parent()); a('<div class="jTagOverlay"></div>').insertBefore(b);var e=b.parent().parent();b.prev();b.parent().css("backgroundImage","url("+b.attr("src")+")");b.parent().width(b.width());b.parent().height(b.height());b.parent().parent().width(b.width());b.hide();c.autoShowDrag&&b.showDrag();e.delegate(".jTagTag","mouseenter",function(){a(".jTagDrag",e).length==0&&(a(this).css("opacity",1),a(".jTagDeleteTag",this).show(),a(this).find("span").show(),b.disableClickToTag())});e.delegate(".jTagTag","mouseleave",function(){a(".jTagDrag", e).length==0&&(c.showTag=="hover"&&(a(this).css("opacity",0),a(".jTagDeleteTag",this).hide(),a(this).find("span").hide()),b.enableClickToTag())});c.showLabels&&c.showTag!="always"&&(e.delegate(".jTagLabels label","mouseenter",function(){a("#"+a(this).attr("rel")).css("opacity",1).find("span").show();a(".jTagDeleteTag",e).show()}),e.delegate(".jTagLabels label","mouseleave",function(){a("#"+a(this).attr("rel")).css("opacity",0).find("span").hide();a(".jTagDeleteTag",e).hide()}));c.canDelete&&e.delegate(".jTagDeleteTag", "click",function(){c.remove&&c.remove(a(this).parent().parent().getId());c.showLabels&&a(".jTagLabels",e).find('label[rel="'+a(this).parent().parent().attr("id")+'"]').remove();a(this).parent().parent().remove();b.enableClickToTag()});c.defaultTags&&a.each(c.defaultTags,function(a,c){b.addTag(c.width,c.height,c.top,c.left,c.label,c.id)});b.enableClickToTag()})})},hideDrag:function(){var c=a(this),b=c.data("options");c.prev().removeClass("jTagPngOverlay");c.parent().parent().find(".jTagDrag").remove(); b.showTag=="always"&&c.parent().parent().find(".jTagTag").show();c.enableClickToTag()},showDrag:function(c){var b=a(this),e=b.parent().parent(),f=b.prev();b.disableClickToTag();var d=b.data("options"),g=function(b){b=a(".jTagDrag",b);border=parseInt(b.css("borderTopWidth"));left_pos=parseInt(b.attr("offsetLeft"))+border;top_pos=parseInt(b.attr("offsetTop"))+border;return"-"+left_pos+"px -"+top_pos+"px"};a(".jTagDrag",f).length!=1&&d.canTag&&(d.showTag=="always"&&a(".jTagTag",f).hide(),a('<div style="width:'+ d.defaultWidth+"px;height:"+d.defaultHeight+'px"class="jTagDrag"><div class="jTagSave"><div class="jTagInput"><input type="text" id="jTagLabel"></div><div class="jTagSaveClose"></div><div class="jTagSaveBtn"></div><div style="clear:both"></div></div>').appendTo(f),f.addClass("jTagPngOverlay"),jtagdrag=a(".jTagDrag",f),jtagdrag.css("backgroundImage","url("+b.attr("src")+")"),c?(pos=function(a){var b=curtop=0;if(a.offsetParent){do b+=a.offsetLeft,curtop+=a.offsetTop;while(a=a.offsetParent);return[b, curtop]}}(b.parent()[0]),x=Math.max(0,c.pageX-pos[0]-d.defaultWidth/2),y=Math.max(0,c.pageY-pos[1]-d.defaultHeight/2),x+jtagdrag.width()>b.parent().width()&&(x=b.parent().width()-jtagdrag.width()-2),y+jtagdrag.height()>b.parent().height()&&(y=b.parent().height()-jtagdrag.height()-2)):y=x=0,jtagdrag.css("top",y).css("left",x),d.autoComplete&&a("#jTagLabel",e).autocomplete({source:d.autoComplete}),a(".jTagSaveBtn",e).click(function(){label=a("#jTagLabel",e).val();label==""?alert("The label cannot be empty"): (height=a(this).parent().parent().height(),width=a(this).parent().parent().width(),top_pos=a(this).parent().parent().attr("offsetTop"),left=a(this).parent().parent().attr("offsetLeft"),tagobj=b.addTag(width,height,top_pos,left,label),d.save&&d.save(width,height,top_pos,left,label,tagobj))}),a(".jTagSaveClose",e).click(function(){b.hideDrag()}),d.resizable&&jtagdrag.resizable({containment:b.parent(),minWidth:d.minWidth,minHeight:d.minHeight,maxWidht:d.maxWidth,maxHeight:d.maxHeight,resize:function(){jtagdrag.css({backgroundPosition:g(f)})}, stop:function(){jtagdrag.css({backgroundPosition:g(f)})}}),d.draggable&&jtagdrag.draggable({containment:b.parent(),drag:function(){jtagdrag.css({backgroundPosition:g(f)})},stop:function(){jtagdrag.css({backgroundPosition:g(f)})}}),jtagdrag.css({backgroundPosition:g(f)}))},addTag:function(c,b,e,f,d,g){var h=a(this),i=h.data("options"),j=a(".jTagTag").length+1;tag=a('<div class="jTagTag" id="tag'+j+'"style="width:'+c+"px;height:"+b+"px;top:"+e+"px;left:"+f+'px;"><div style="width:100%;height:100%"><div class="jTagDeleteTag"></div><span>'+ d+"</span></div></div>").appendTo(h.prev());g&&tag.setId(g);i.canDelete&&h.parent().find(".jTagDeleteTag").show();i.showTag=="always"&&a(".jTagTag").css("opacity",1);i.showLabels&&a("<label rel='tag"+j+"'>"+d+"</label>").insertBefore(a(".jTagLabels div:last"));h.hideDrag();return tag},setId:function(c){a(this).hasClass("jTagTag")?a(this).data("tagid",c):alert("Wrong object")},getId:function(){if(a(this).hasClass("jTagTag"))return a(this).data("tagid");else alert("Wrong object")},enableClickToTag:function(){var c= a(this);c.data("options").clickToTag&&c.parent().mousedown(function(a){c.showDrag(a);c.parent().unbind("mousedown")})},disableClickToTag:function(){var c=a(this);c.data("options").clickToTag&&c.parent().unbind("mousedown")}})})(jQuery);
